<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - AI Powered Insights</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .analytics-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8ecff 100%);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .ai-insight-card {
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            border-left: 4px solid #ff6b6b;
        }
        
        .trend-positive {
            color: #10b981;
        }
        
        .trend-negative {
            color: #ef4444;
        }
        
        .trend-neutral {
            color: #6b7280;
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .gradient-text {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .ai-badge {
            background: linear-gradient(45deg, #ff6b6b, #ffa500);
            color: white;
            animation: pulse 2s infinite;
        }
        
        .report-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .progress-ring {
            transform: rotate(-90deg);
        }
        
        .progress-ring-circle {
            transition: stroke-dasharray 0.5s ease;
            fill: transparent;
            stroke-width: 8;
            stroke-linecap: round;
        }
        
        .nav-tab {
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-color: #ff6b6b;
        }
        
        .insight-priority-high {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }
        
        .insight-priority-medium {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }
        
        .insight-priority-low {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }
        
        .forecast-chart {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .export-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="analytics-container min-h-screen p-4">
        <!-- Header Section -->
        <div class="max-w-7xl mx-auto">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-2xl mb-4 shadow-lg">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                </div>
                <h1 class="text-4xl font-bold gradient-text mb-3">Analytics Dashboard</h1>
                <p class="text-gray-600 mb-4">Comprehensive productivity insights with advanced charts and performance tracking</p>
                <div class="inline-flex items-center space-x-4">
                    <span class="ai-badge px-4 py-2 rounded-full text-sm font-semibold">AI Powered</span>
                    <div class="flex items-center space-x-2">
                        <div id="aiStatus" class="w-3 h-3 bg-green-500 rounded-full pulse-animation"></div>
                        <span class="text-sm text-gray-600">AI Analysis Active</span>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex flex-wrap justify-center mb-8 bg-white rounded-xl p-2 shadow-lg">
                <button class="nav-tab active px-6 py-3 rounded-lg font-medium text-sm mx-1 mb-2" onclick="showTab('overview')">
                    üìä Overview
                </button>
                <button class="nav-tab px-6 py-3 rounded-lg font-medium text-sm mx-1 mb-2" onclick="showTab('productivity')">
                    ‚ö° Productivity
                </button>
                <button class="nav-tab px-6 py-3 rounded-lg font-medium text-sm mx-1 mb-2" onclick="showTab('trends')">
                    üìà Trends
                </button>
                <button class="nav-tab px-6 py-3 rounded-lg font-medium text-sm mx-1 mb-2" onclick="showTab('insights')">
                    üß† AI Insights
                </button>
                <button class="nav-tab px-6 py-3 rounded-lg font-medium text-sm mx-1 mb-2" onclick="showTab('reports')">
                    üìã Reports
                </button>
                <button class="nav-tab px-6 py-3 rounded-lg font-medium text-sm mx-1 mb-2" onclick="showTab('forecasting')">
                    üîÆ Forecasting
                </button>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content">
                <!-- Key Metrics Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="metric-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-medium text-gray-600">Total Focus Time</h3>
                            <span class="text-2xl">‚è±Ô∏è</span>
                        </div>
                        <div class="text-3xl font-bold text-gray-800" id="totalFocusTime">0h</div>
                        <div class="text-sm text-gray-500 mt-2">
                            <span class="trend-positive" id="focusTimeTrend">+0%</span> vs last week
                        </div>
                    </div>

                    <div class="metric-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-medium text-gray-600">Sessions Completed</h3>
                            <span class="text-2xl">‚úÖ</span>
                        </div>
                        <div class="text-3xl font-bold text-gray-800" id="completedSessions">0</div>
                        <div class="text-sm text-gray-500 mt-2">
                            <span class="trend-positive" id="sessionsTrend">+0%</span> vs last week
                        </div>
                    </div>

                    <div class="metric-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-medium text-gray-600">Productivity Score</h3>
                            <span class="text-2xl">üéØ</span>
                        </div>
                        <div class="text-3xl font-bold text-gray-800" id="productivityScore">0</div>
                        <div class="text-sm text-gray-500 mt-2">
                            AI calculated score
                        </div>
                    </div>

                    <div class="metric-card rounded-xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-medium text-gray-600">Goal Progress</h3>
                            <span class="text-2xl">üé™</span>
                        </div>
                        <div class="text-3xl font-bold text-gray-800" id="goalProgress">0%</div>
                        <div class="text-sm text-gray-500 mt-2">
                            <span class="trend-positive" id="goalTrend">+0%</span> this month
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Weekly Focus Trend</h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                                <span class="text-sm text-gray-600">Focus Hours</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="weeklyTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Session Types Distribution</h3>
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span class="text-sm text-gray-600">Sessions</span>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="sessionTypesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- AI Insights Row -->
                <div class="ai-insight-card rounded-xl p-6 mb-8">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-red-400 to-orange-500 rounded-full flex items-center justify-center mr-4">
                            <span class="text-white text-xl">ü§ñ</span>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">AI Performance Analysis</h3>
                            <p class="text-gray-600 text-sm">Real-time insights based on your profile and focus data</p>
                        </div>
                        <button class="ml-auto bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all" onclick="generateAIInsights()">
                            üîÑ Refresh Analysis
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="aiInsightsContainer">
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-center mb-2">
                                <span class="text-lg mr-2">üéØ</span>
                                <h4 class="font-semibold text-gray-700">Performance Pattern</h4>
                            </div>
                            <p class="text-sm text-gray-600">Complete your first focus session to unlock AI insights.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Productivity Tab -->
            <div id="productivity-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                    <!-- Productivity Score Circle -->
                    <div class="bg-white rounded-xl p-6 shadow-lg text-center">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Current Productivity Score</h3>
                        <div class="relative inline-flex items-center justify-center">
                            <svg class="w-32 h-32 progress-ring">
                                <circle class="progress-ring-circle" stroke="#e5e7eb" stroke-width="8" r="56" cx="64" cy="64"/>
                                <circle class="progress-ring-circle" stroke="url(#gradient)" stroke-width="8" r="56" cx="64" cy="64" 
                                        id="progressCircle" stroke-dasharray="0 351.86"/>
                            </svg>
                            <div class="absolute text-2xl font-bold text-gray-800" id="scoreDisplay">0</div>
                            <defs>
                                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" style="stop-color:#667eea"/>
                                    <stop offset="100%" style="stop-color:#764ba2"/>
                                </linearGradient>
                            </defs>
                        </div>
                        <p class="text-sm text-gray-600 mt-4">Based on focus patterns and goal alignment</p>
                    </div>

                    <!-- Recent Sessions -->
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Recent Focus Sessions</h3>
                        <div id="recentSessions" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">
                                <span class="text-4xl block mb-2">üìä</span>
                                <p>No focus sessions yet</p>
                                <p class="text-sm">Start a focus session to see your data here</p>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Goals Progress -->
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Today's Goals</h3>
                        <div id="dailyGoals" class="space-y-4">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 border-2 border-gray-300 rounded mr-3"></div>
                                    <span class="text-sm text-gray-600">Complete 2 focus sessions</span>
                                </div>
                                <span class="text-xs text-gray-500">0/2</span>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 border-2 border-gray-300 rounded mr-3"></div>
                                    <span class="text-sm text-gray-600">Focus for 1 hour</span>
                                </div>
                                <span class="text-xs text-gray-500">0/60 min</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Productivity Metrics -->
                <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-6">Detailed Productivity Metrics</h3>
                    <div class="chart-container mb-6">
                        <canvas id="productivityChart"></canvas>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <div class="text-2xl font-bold text-blue-600" id="avgSessionLength">0 min</div>
                            <div class="text-sm text-gray-600">Avg Session Length</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <div class="text-2xl font-bold text-green-600" id="completionRate">0%</div>
                            <div class="text-sm text-gray-600">Completion Rate</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded-lg">
                            <div class="text-2xl font-bold text-purple-600" id="streakDays">0</div>
                            <div class="text-sm text-gray-600">Current Streak</div>
                        </div>
                        <div class="text-center p-4 bg-orange-50 rounded-lg">
                            <div class="text-2xl font-bold text-orange-600" id="weeklyImprovement">0%</div>
                            <div class="text-sm text-gray-600">Weekly Improvement</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div id="trends-tab" class="tab-content hidden">
                <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Trend Analysis & Forecasting</h3>
                        <div class="flex space-x-2">
                            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm" onclick="updateTrends('7d')">7 Days</button>
                            <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm" onclick="updateTrends('30d')">30 Days</button>
                            <button class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm" onclick="updateTrends('90d')">90 Days</button>
                        </div>
                    </div>
                    <div class="chart-container mb-6">
                        <canvas id="trendsChart"></canvas>
                    </div>
                </div>

                <!-- Trend Insights -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">üìà Performance Trends</h4>
                        <div id="performanceTrends" class="space-y-3">
                            <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                                <div class="flex items-center">
                                    <span class="text-green-500 mr-2">üìà</span>
                                    <span class="text-sm">Focus Duration</span>
                                </div>
                                <span class="text-sm font-medium text-green-600">+15% improvement</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">üîÆ AI Predictions</h4>
                        <div id="aiPredictions" class="space-y-3">
                            <div class="p-3 bg-blue-50 rounded-lg">
                                <div class="text-sm font-medium text-blue-800">Next Week Forecast</div>
                                <div class="text-xs text-blue-600 mt-1">Based on current trends, you're likely to achieve 85% of your focus goals</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Insights Tab -->
            <div id="insights-tab" class="tab-content hidden">
                <div class="mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">AI-Generated Insights</h3>
                            <p class="text-gray-600">Personalized recommendations based on your profile and performance data</p>
                        </div>
                        <button class="bg-gradient-to-r from-red-500 to-orange-500 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all" onclick="runFullAIAnalysis()">
                            üß† Run Deep Analysis
                        </button>
                    </div>

                    <div id="insightsPriority" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- High Priority Insights -->
                        <div class="insight-priority-high rounded-xl p-6 border-l-4">
                            <div class="flex items-center mb-3">
                                <span class="text-red-500 text-xl mr-2">üö®</span>
                                <h4 class="font-semibold text-gray-800">High Priority</h4>
                            </div>
                            <div id="highPriorityInsights">
                                <p class="text-sm text-gray-600">Complete your profile to unlock priority insights.</p>
                            </div>
                        </div>

                        <!-- Medium Priority Insights -->
                        <div class="insight-priority-medium rounded-xl p-6 border-l-4">
                            <div class="flex items-center mb-3">
                                <span class="text-yellow-500 text-xl mr-2">‚ö†Ô∏è</span>
                                <h4 class="font-semibold text-gray-800">Medium Priority</h4>
                            </div>
                            <div id="mediumPriorityInsights">
                                <p class="text-sm text-gray-600">Start focus sessions to get performance insights.</p>
                            </div>
                        </div>

                        <!-- Low Priority Insights -->
                        <div class="insight-priority-low rounded-xl p-6 border-l-4">
                            <div class="flex items-center mb-3">
                                <span class="text-green-500 text-xl mr-2">üí°</span>
                                <h4 class="font-semibold text-gray-800">Optimization Tips</h4>
                            </div>
                            <div id="lowPriorityInsights">
                                <p class="text-sm text-gray-600">Tips and optimizations will appear here.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed AI Analysis -->
                    <div class="bg-white rounded-xl p-6 shadow-lg">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">ü§ñ Detailed AI Analysis</h4>
                        <div id="detailedAnalysis" class="prose max-w-none">
                            <div class="text-center py-8 text-gray-500">
                                <div class="text-4xl mb-4">üîç</div>
                                <p class="mb-4">Ready to analyze your productivity patterns</p>
                                <p class="text-sm">The AI will examine your focus sessions, profile data, and goals to provide personalized insights.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-tab" class="tab-content hidden">
                <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-semibold text-gray-800">Custom Reporting Tools</h3>
                        <div class="flex space-x-2">
                            <button class="export-btn text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all" onclick="exportReport('pdf')">
                                üìÑ Export PDF
                            </button>
                            <button class="export-btn text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all" onclick="exportReport('csv')">
                                üìä Export CSV
                            </button>
                        </div>
                    </div>

                    <!-- Report Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date Range</label>
                            <select class="w-full p-2 border border-gray-300 rounded-lg text-sm" id="reportDateRange">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Report Type</label>
                            <select class="w-full p-2 border border-gray-300 rounded-lg text-sm" id="reportType">
                                <option value="summary">Executive Summary</option>
                                <option value="detailed">Detailed Analysis</option>
                                <option value="goals">Goals Progress</option>
                                <option value="trends">Trend Analysis</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Include AI Insights</label>
                            <select class="w-full p-2 border border-gray-300 rounded-lg text-sm" id="includeAI">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button class="w-full bg-blue-500 text-white p-2 rounded-lg hover:bg-blue-600 transition-colors" onclick="generateReport()">
                                Generate Report
                            </button>
                        </div>
                    </div>

                    <!-- Report Preview -->
                    <div id="reportPreview" class="border border-gray-200 rounded-lg p-6">
                        <div class="text-center py-12 text-gray-500">
                            <div class="text-4xl mb-4">üìã</div>
                            <p class="mb-2">Report Preview</p>
                            <p class="text-sm">Configure your report settings and click "Generate Report" to see the preview</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Forecasting Tab -->
            <div id="forecasting-tab" class="tab-content hidden">
                <div class="bg-white rounded-xl p-6 shadow-lg mb-8">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">AI Performance Forecasting</h3>
                            <p class="text-gray-600">Predictive analytics based on your historical data and trends</p>
                        </div>
                        <button class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-lg hover:shadow-lg transition-all" onclick="generateForecast()">
                            üîÆ Generate Forecast
                        </button>
                    </div>

                    <!-- Forecast Chart -->
                    <div class="forecast-chart mb-6">
                        <div class="chart-container">
                            <canvas id="forecastChart"></canvas>
                        </div>
                    </div>

                    <!-- Forecast Insights -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white rounded-xl p-6 shadow-sm border">
                            <h4 class="font-semibold text-gray-800 mb-3">üìÖ Next Week Prediction</h4>
                            <div id="weekForecast" class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Focus Hours:</span>
                                    <span class="text-sm font-medium">12-15h</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Sessions:</span>
                                    <span class="text-sm font-medium">8-10</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Productivity Score:</span>
                                    <span class="text-sm font-medium text-green-600">85-90</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm border">
                            <h4 class="font-semibold text-gray-800 mb-3">üéØ Goal Achievement Forecast</h4>
                            <div id="goalForecast" class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Weekly Goal:</span>
                                    <span class="text-sm font-medium text-green-600">95% likely</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Monthly Goal:</span>
                                    <span class="text-sm font-medium text-yellow-600">75% likely</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-sm text-gray-600">Quarterly Goal:</span>
                                    <span class="text-sm font-medium text-orange-600">60% likely</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl p-6 shadow-sm border">
                            <h4 class="font-semibold text-gray-800 mb-3">üöÄ Improvement Opportunities</h4>
                            <div id="improvementForecast" class="space-y-2 text-sm">
                                <p class="text-gray-600">Extend focus sessions by 5 minutes to increase weekly productivity by 12%</p>
                                <p class="text-gray-600">Schedule sessions in the morning for 15% better completion rates</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class AnalyticsDashboard {
            constructor() {
                this.apiKey = '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';
                this.data = {
                    sessions: [],
                    profile: null,
                    metrics: {
                        totalFocusTime: 0,
                        completedSessions: 0,
                        productivityScore: 0,
                        goalProgress: 0
                    }
                };
                this.charts = {};
                this.aiInsights = [];
                this.currentTab = 'overview';
                
                this.init();
            }

            async init() {
                this.loadStoredData();
                this.setupEventListeners();
                this.initializeCharts();
                this.updateDashboard();
                
                // Run initial AI analysis if data exists
                if (this.data.sessions.length > 0 || this.data.profile) {
                    await this.generateAIInsights();
                }
                
                // Start periodic updates
                setInterval(() => this.updateDashboard(), 30000); // Update every 30 seconds
            }

            loadStoredData() {
                // Load profile data
                try {
                    const profileData = localStorage.getItem('userProfile');
                    if (profileData) {
                        this.data.profile = JSON.parse(profileData);
                    }
                } catch (error) {
                    console.error('Error loading profile data:', error);
                }

                // Load focus session data
                try {
                    const sessionsData = localStorage.getItem('focusSessions');
                    if (sessionsData) {
                        this.data.sessions = JSON.parse(sessionsData);
                    }
                    
                    // Also check for recent session data
                    const recentSession = localStorage.getItem('lastFocusSession');
                    if (recentSession) {
                        const session = JSON.parse(recentSession);
                        // Add to sessions if not already there
                        const exists = this.data.sessions.find(s => s.completedAt === session.completedAt);
                        if (!exists) {
                            this.data.sessions.push(session);
                            this.saveSessionsData();
                        }
                    }
                } catch (error) {
                    console.error('Error loading sessions data:', error);
                }

                this.calculateMetrics();
            }

            saveSessionsData() {
                try {
                    localStorage.setItem('focusSessions', JSON.stringify(this.data.sessions));
                } catch (error) {
                    console.error('Error saving sessions data:', error);
                }
            }

            calculateMetrics() {
                const sessions = this.data.sessions;
                
                // Calculate total focus time
                this.data.metrics.totalFocusTime = sessions.reduce((total, session) => {
                    return total + (session.duration || 0);
                }, 0);

                // Count completed sessions
                this.data.metrics.completedSessions = sessions.length;

                // Calculate productivity score (0-100)
                let score = 0;
                if (sessions.length > 0) {
                    const avgDuration = this.data.metrics.totalFocusTime / sessions.length;
                    const completionRate = 100; // Assuming all stored sessions were completed
                    const consistencyBonus = Math.min(sessions.length * 2, 20); // Up to 20 points for consistency
                    
                    score = Math.min(
                        (avgDuration / 25) * 40 + // Up to 40 points for session length
                        (completionRate / 100) * 40 + // Up to 40 points for completion rate
                        consistencyBonus, // Up to 20 points for consistency
                        100
                    );
                }
                this.data.metrics.productivityScore = Math.round(score);

                // Calculate goal progress based on profile goals
                this.data.metrics.goalProgress = this.calculateGoalProgress();
            }

            calculateGoalProgress() {
                if (!this.data.profile) return 0;
                
                let progress = 0;
                const sessions = this.data.sessions;
                
                // Check weekly hours goal
                if (this.data.profile.weeklyHours) {
                    const weeklyGoal = this.parseWeeklyHours(this.data.profile.weeklyHours);
                    const thisWeekSessions = this.getThisWeekSessions();
                    const thisWeekHours = thisWeekSessions.reduce((total, s) => total + s.duration, 0) / 60;
                    
                    progress += Math.min((thisWeekHours / weeklyGoal) * 100, 100) * 0.5;
                }
                
                // Add progress based on session consistency
                if (sessions.length > 0) {
                    const daysSinceFirst = this.getDaysSinceFirstSession();
                    const expectedSessions = Math.max(daysSinceFirst * 0.5, 1); // Expect at least 0.5 sessions per day
                    progress += Math.min((sessions.length / expectedSessions) * 100, 100) * 0.5;
                }
                
                return Math.round(progress);
            }

            parseWeeklyHours(weeklyHoursStr) {
                if (!weeklyHoursStr) return 10; // Default
                
                const ranges = {
                    '1-5': 3,
                    '6-10': 8,
                    '11-20': 15,
                    '20+': 25
                };
                
                return ranges[weeklyHoursStr] || 10;
            }

            getThisWeekSessions() {
                const now = new Date();
                const weekStart = new Date(now);
                weekStart.setDate(now.getDate() - now.getDay());
                weekStart.setHours(0, 0, 0, 0);
                
                return this.data.sessions.filter(session => {
                    const sessionDate = new Date(session.completedAt);
                    return sessionDate >= weekStart;
                });
            }

            getDaysSinceFirstSession() {
                if (this.data.sessions.length === 0) return 1;
                
                const firstSession = new Date(Math.min(...this.data.sessions.map(s => new Date(s.completedAt))));
                const now = new Date();
                const diffTime = Math.abs(now - firstSession);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                return diffDays || 1;
            }

            setupEventListeners() {
                // Check for new session data periodically
                setInterval(() => {
                    this.checkForNewSessionData();
                }, 5000);
            }

            checkForNewSessionData() {
                try {
                    const recentSession = localStorage.getItem('lastFocusSession');
                    if (recentSession) {
                        const session = JSON.parse(recentSession);
                        const exists = this.data.sessions.find(s => s.completedAt === session.completedAt);
                        if (!exists) {
                            this.data.sessions.push(session);
                            this.saveSessionsData();
                            this.calculateMetrics();
                            this.updateDashboard();
                            this.showNotification('üìä New focus session added to analytics!', 'success');
                        }
                    }
                } catch (error) {
                    console.error('Error checking for new session data:', error);
                }
            }

            updateDashboard() {
                this.updateMetricsDisplay();
                this.updateCharts();
                this.updateRecentSessions();
                this.updateProductivityScore();
            }

            updateMetricsDisplay() {
                const metrics = this.data.metrics;
                
                // Update overview metrics
                document.getElementById('totalFocusTime').textContent = this.formatTime(metrics.totalFocusTime);
                document.getElementById('completedSessions').textContent = metrics.completedSessions;
                document.getElementById('productivityScore').textContent = metrics.productivityScore;
                document.getElementById('goalProgress').textContent = metrics.goalProgress + '%';
                
                // Update trends (simplified calculation)
                const thisWeekSessions = this.getThisWeekSessions();
                const lastWeekSessions = this.getLastWeekSessions();
                
                const focusTimeTrend = this.calculateTrend(
                    thisWeekSessions.reduce((t, s) => t + s.duration, 0),
                    lastWeekSessions.reduce((t, s) => t + s.duration, 0)
                );
                
                const sessionsTrend = this.calculateTrend(thisWeekSessions.length, lastWeekSessions.length);
                
                this.updateTrendDisplay('focusTimeTrend', focusTimeTrend);
                this.updateTrendDisplay('sessionsTrend', sessionsTrend);
                this.updateTrendDisplay('goalTrend', Math.min(metrics.goalProgress, 100));
            }

            getLastWeekSessions() {
                const now = new Date();
                const lastWeekStart = new Date(now);
                lastWeekStart.setDate(now.getDate() - now.getDay() - 7);
                lastWeekStart.setHours(0, 0, 0, 0);
                
                const lastWeekEnd = new Date(lastWeekStart);
                lastWeekEnd.setDate(lastWeekStart.getDate() + 7);
                
                return this.data.sessions.filter(session => {
                    const sessionDate = new Date(session.completedAt);
                    return sessionDate >= lastWeekStart && sessionDate < lastWeekEnd;
                });
            }

            calculateTrend(current, previous) {
                if (previous === 0) return current > 0 ? 100 : 0;
                return Math.round(((current - previous) / previous) * 100);
            }

            updateTrendDisplay(elementId, trend) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                element.textContent = (trend >= 0 ? '+' : '') + trend + '%';
                element.className = trend >= 0 ? 'trend-positive' : 'trend-negative';
            }

            formatTime(minutes) {
                if (minutes < 60) {
                    return minutes + 'm';
                } else {
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    return hours + 'h' + (mins > 0 ? ' ' + mins + 'm' : '');
                }
            }

            initializeCharts() {
                this.initWeeklyTrendChart();
                this.initSessionTypesChart();
                this.initProductivityChart();
                this.initTrendsChart();
                this.initForecastChart();
            }

            initWeeklyTrendChart() {
                const ctx = document.getElementById('weeklyTrendChart');
                if (!ctx) return;
                
                const weeklyData = this.getWeeklyTrendData();
                
                this.charts.weeklyTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: weeklyData.labels,
                        datasets: [{
                            label: 'Focus Hours',
                            data: weeklyData.data,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Hours'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            getWeeklyTrendData() {
                const labels = [];
                const data = [];
                
                // Get last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    
                    // Calculate hours for this day
                    const dayStart = new Date(date);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(date);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const dayMinutes = this.data.sessions
                        .filter(session => {
                            const sessionDate = new Date(session.completedAt);
                            return sessionDate >= dayStart && sessionDate <= dayEnd;
                        })
                        .reduce((total, session) => total + session.duration, 0);
                    
                    data.push(Math.round(dayMinutes / 60 * 10) / 10); // Round to 1 decimal place
                }
                
                return { labels, data };
            }

            initSessionTypesChart() {
                const ctx = document.getElementById('sessionTypesChart');
                if (!ctx) return;
                
                const typesData = this.getSessionTypesData();
                
                this.charts.sessionTypes = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: typesData.labels,
                        datasets: [{
                            data: typesData.data,
                            backgroundColor: [
                                '#10b981',
                                '#3b82f6',
                                '#f59e0b',
                                '#ef4444',
                                '#8b5cf6',
                                '#06b6d4'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            getSessionTypesData() {
                const types = {};
                
                this.data.sessions.forEach(session => {
                    const type = session.animationType || 'default';
                    types[type] = (types[type] || 0) + 1;
                });
                
                if (Object.keys(types).length === 0) {
                    return {
                        labels: ['No Data'],
                        data: [1]
                    };
                }
                
                return {
                    labels: Object.keys(types).map(type => type.charAt(0).toUpperCase() + type.slice(1)),
                    data: Object.values(types)
                };
            }

            initProductivityChart() {
                const ctx = document.getElementById('productivityChart');
                if (!ctx) return;
                
                const productivityData = this.getProductivityData();
                
                this.charts.productivity = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: productivityData.labels,
                        datasets: [{
                            label: 'Productivity Score',
                            data: productivityData.data,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Score'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            getProductivityData() {
                const labels = [];
                const data = [];
                
                // Get last 7 days productivity scores
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    // Calculate productivity score for this day
                    const dayStart = new Date(date);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(date);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const daySessions = this.data.sessions.filter(session => {
                        const sessionDate = new Date(session.completedAt);
                        return sessionDate >= dayStart && sessionDate <= dayEnd;
                    });
                    
                    let dayScore = 0;
                    if (daySessions.length > 0) {
                        const avgDuration = daySessions.reduce((total, s) => total + s.duration, 0) / daySessions.length;
                        const sessionCount = daySessions.length;
                        dayScore = Math.min((avgDuration / 25) * 50 + sessionCount * 10, 100);
                    }
                    
                    data.push(Math.round(dayScore));
                }
                
                return { labels, data };
            }

            initTrendsChart() {
                const ctx = document.getElementById('trendsChart');
                if (!ctx) return;
                
                const trendsData = this.getTrendsData();
                
                this.charts.trends = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: trendsData.labels,
                        datasets: [
                            {
                                label: 'Focus Time (hours)',
                                data: trendsData.focusTime,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                yAxisID: 'y'
                            },
                            {
                                label: 'Session Count',
                                data: trendsData.sessions,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Hours'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Sessions'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }

            getTrendsData() {
                const labels = [];
                const focusTime = [];
                const sessions = [];
                
                // Get last 30 days
                for (let i = 29; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    
                    const dayStart = new Date(date);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(date);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const daySessions = this.data.sessions.filter(session => {
                        const sessionDate = new Date(session.completedAt);
                        return sessionDate >= dayStart && sessionDate <= dayEnd;
                    });
                    
                    const dayMinutes = daySessions.reduce((total, session) => total + session.duration, 0);
                    
                    focusTime.push(Math.round(dayMinutes / 60 * 10) / 10);
                    sessions.push(daySessions.length);
                }
                
                return { labels, focusTime, sessions };
            }

            initForecastChart() {
                const ctx = document.getElementById('forecastChart');
                if (!ctx) return;
                
                const forecastData = this.getForecastData();
                
                this.charts.forecast = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: forecastData.labels,
                        datasets: [
                            {
                                label: 'Historical Data',
                                data: forecastData.historical,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)'
                            },
                            {
                                label: 'Predicted Data',
                                data: forecastData.predicted,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Focus Hours'
                                }
                            }
                        }
                    }
                });
            }

            getForecastData() {
                const labels = [];
                const historical = [];
                const predicted = [];
                
                // Historical data (last 7 days)
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    
                    const dayStart = new Date(date);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(date);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const dayMinutes = this.data.sessions
                        .filter(session => {
                            const sessionDate = new Date(session.completedAt);
                            return sessionDate >= dayStart && sessionDate <= dayEnd;
                        })
                        .reduce((total, session) => total + session.duration, 0);
                    
                    historical.push(Math.round(dayMinutes / 60 * 10) / 10);
                    predicted.push(null);
                }
                
                // Predicted data (next 7 days)
                const avgDaily = historical.reduce((a, b) => a + b, 0) / historical.length || 1;
                const trend = this.calculateTrendSlope(historical);
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() + i + 1);
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    
                    historical.push(null);
                    
                    // Simple prediction: average + trend
                    const prediction = Math.max(avgDaily + (trend * i), 0);
                    predicted.push(Math.round(prediction * 10) / 10);
                }
                
                return { labels, historical, predicted };
            }

            calculateTrendSlope(data) {
                if (data.length < 2) return 0;
                
                let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
                const n = data.length;
                
                for (let i = 0; i < n; i++) {
                    sumX += i;
                    sumY += data[i];
                    sumXY += i * data[i];
                    sumXX += i * i;
                }
                
                return (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX) || 0;
            }

            updateCharts() {
                // Update chart data
                Object.keys(this.charts).forEach(chartKey => {
                    const chart = this.charts[chartKey];
                    if (chart && chart.update) {
                        chart.update('none');
                    }
                });
            }

            updateRecentSessions() {
                const container = document.getElementById('recentSessions');
                if (!container) return;
                
                const recentSessions = this.data.sessions
                    .slice(-5)
                    .reverse();
                
                if (recentSessions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <span class="text-4xl block mb-2">üìä</span>
                            <p>No focus sessions yet</p>
                            <p class="text-sm">Start a focus session to see your data here</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = recentSessions.map(session => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center">
                            <span class="text-xl mr-3">${session.completedEmoji || 'üå±'}</span>
                            <div>
                                <div class="font-medium text-gray-800">${session.duration} min session</div>
                                <div class="text-xs text-gray-500">${new Date(session.completedAt).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="text-sm text-blue-600 font-medium">+${session.points || 0} pts</div>
                    </div>
                `).join('');
            }

            updateProductivityScore() {
                const scoreElement = document.getElementById('scoreDisplay');
                const progressCircle = document.getElementById('progressCircle');
                
                if (scoreElement && progressCircle) {
                    const score = this.data.metrics.productivityScore;
                    scoreElement.textContent = score;
                    
                    // Update progress circle
                    const circumference = 2 * Math.PI * 56; // radius = 56
                    const offset = circumference - (score / 100) * circumference;
                    progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
                    progressCircle.style.strokeDashoffset = offset;
                }

                // Update detailed metrics
                document.getElementById('avgSessionLength').textContent = this.getAverageSessionLength();
                document.getElementById('completionRate').textContent = '100%'; // Assuming all stored sessions were completed
                document.getElementById('streakDays').textContent = this.getCurrentStreak();
                document.getElementById('weeklyImprovement').textContent = this.getWeeklyImprovement();
            }

            getAverageSessionLength() {
                if (this.data.sessions.length === 0) return '0 min';
                const avg = this.data.metrics.totalFocusTime / this.data.sessions.length;
                return Math.round(avg) + ' min';
            }

            getCurrentStreak() {
                // Simple streak calculation - consecutive days with at least one session
                let streak = 0;
                const today = new Date();
                
                for (let i = 0; i < 30; i++) { // Check last 30 days
                    const checkDate = new Date(today);
                    checkDate.setDate(today.getDate() - i);
                    
                    const dayStart = new Date(checkDate);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(checkDate);
                    dayEnd.setHours(23, 59, 59, 999);
                    
                    const hasSessions = this.data.sessions.some(session => {
                        const sessionDate = new Date(session.completedAt);
                        return sessionDate >= dayStart && sessionDate <= dayEnd;
                    });
                    
                    if (hasSessions) {
                        streak++;
                    } else {
                        break;
                    }
                }
                
                return streak;
            }

            getWeeklyImprovement() {
                const thisWeek = this.getThisWeekSessions();
                const lastWeek = this.getLastWeekSessions();
                
                const thisWeekHours = thisWeek.reduce((total, s) => total + s.duration, 0) / 60;
                const lastWeekHours = lastWeek.reduce((total, s) => total + s.duration, 0) / 60;
                
                if (lastWeekHours === 0) return thisWeekHours > 0 ? '100%' : '0%';
                
                const improvement = Math.round(((thisWeekHours - lastWeekHours) / lastWeekHours) * 100);
                return (improvement >= 0 ? '+' : '') + improvement + '%';
            }

            async generateAIInsights() {
                this.updateAIStatus('processing');
                
                try {
                    const prompt = this.buildAIAnalysisPrompt();
                    const aiResponse = await this.makeAIRequest(prompt);
                    
                    this.processAIResponse(aiResponse);
                    this.updateAIStatus('ready');
                    
                } catch (error) {
                    console.error('AI Analysis Error:', error);
                    this.generateFallbackInsights();
                    this.updateAIStatus('ready');
                }
            }

            buildAIAnalysisPrompt() {
                const profile = this.data.profile || {};
                const sessions = this.data.sessions;
                const metrics = this.data.metrics;
                
                return `Analyze this user's productivity data and provide actionable insights:

PROFILE DATA:
- Name: ${profile.fullName || 'User'}
- Profession: ${profile.profession || 'Not specified'}
- Experience: ${profile.experience || 'Not specified'}
- Skills: ${(profile.skills || []).join(', ') || 'Not specified'}
- Primary Goal: ${profile.primaryGoal || 'Not specified'}
- Weekly Hours Goal: ${profile.weeklyHours || 'Not specified'}
- Work Style: ${profile.workStyle || 'Not specified'}
- Motivation: ${profile.motivation || 'Not specified'}

PERFORMANCE DATA:
- Total Focus Time: ${metrics.totalFocusTime} minutes
- Completed Sessions: ${metrics.completedSessions}
- Current Productivity Score: ${metrics.productivityScore}/100
- Goal Progress: ${metrics.goalProgress}%
- Current Streak: ${this.getCurrentStreak()} days
- Average Session Length: ${this.getAverageSessionLength()}

SESSION PATTERNS:
- Most recent sessions: ${sessions.slice(-3).map(s => `${s.duration}min (${s.animationType || 'default'})`).join(', ') || 'None'}
- Session frequency: ${sessions.length} sessions over ${this.getDaysSinceFirstSession()} days

Please provide:
1. 3-5 key insights about their performance patterns
2. Specific recommendations for improvement
3. Predictions about their goal achievement likelihood
4. Priority areas to focus on

Keep responses concise and actionable.`;
            }

            async makeAIRequest(prompt) {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Analytics Dashboard'
                    },
                    body: JSON.stringify({
                        model: 'meta-llama/llama-3.1-8b-instruct:free',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an AI productivity analyst. Provide detailed, actionable insights based on user productivity data. Be specific and helpful.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            processAIResponse(response) {
                // Parse AI response and update insights
                this.aiInsights = this.parseAIInsights(response);
                this.updateAIInsightsDisplay();
                this.updateDetailedAnalysis(response);
            }

            parseAIInsights(response) {
                // Simple parsing - in production, you'd use more sophisticated NLP
                const sections = response.split('\n\n');
                const insights = [];
                
                sections.forEach((section, index) => {
                    if (section.trim() && section.length > 50) {
                        const priority = index === 0 ? 'high' : index === 1 ? 'medium' : 'low';
                        insights.push({
                            priority: priority,
                            content: section.trim(),
                            icon: this.getInsightIcon(priority)
                        });
                    }
                });
                
                return insights.length > 0 ? insights : this.getFallbackInsights();
            }

            getInsightIcon(priority) {
                const icons = {
                    high: 'üö®',
                    medium: '‚ö†Ô∏è',
                    low: 'üí°'
                };
                return icons[priority] || 'üí°';
            }

            updateAIInsightsDisplay() {
                const container = document.getElementById('aiInsightsContainer');
                if (!container) return;
                
                const insights = this.aiInsights.slice(0, 6); // Limit to 6 insights
                
                container.innerHTML = insights.map((insight, index) => `
                    <div class="bg-white rounded-lg p-4 shadow-sm fade-in" style="animation-delay: ${index * 0.1}s">
                        <div class="flex items-center mb-2">
                            <span class="text-lg mr-2">${insight.icon}</span>
                            <h4 class="font-semibold text-gray-700">AI Insight #${index + 1}</h4>
                        </div>
                        <p class="text-sm text-gray-600">${insight.content.substring(0, 150)}...</p>
                    </div>
                `).join('');
                
                // Update priority sections
                this.updatePriorityInsights();
            }

            updatePriorityInsights() {
                const priorities = ['high', 'medium', 'low'];
                
                priorities.forEach(priority => {
                    const container = document.getElementById(`${priority}PriorityInsights`);
                    if (!container) return;
                    
                    const priorityInsights = this.aiInsights.filter(insight => insight.priority === priority);
                    
                    if (priorityInsights.length === 0) {
                        container.innerHTML = `<p class="text-sm text-gray-600">No ${priority} priority insights at this time.</p>`;
                        return;
                    }
                    
                    container.innerHTML = priorityInsights.map(insight => `
                        <div class="mb-3 p-2 bg-white bg-opacity-50 rounded">
                            <p class="text-sm text-gray-700">${insight.content.substring(0, 200)}...</p>
                        </div>
                    `).join('');
                });
            }

            updateDetailedAnalysis(response) {
                const container = document.getElementById('detailedAnalysis');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                            <div class="flex items-center mb-2">
                                <span class="text-blue-600 text-lg mr-2">ü§ñ</span>
                                <h4 class="font-semibold text-blue-800">AI Analysis Results</h4>
                            </div>
                            <div class="text-sm text-blue-700 whitespace-pre-wrap">${response}</div>
                        </div>
                        <div class="text-xs text-gray-500 text-center">
                            Analysis generated on ${new Date().toLocaleString()}
                        </div>
                    </div>
                `;
            }

            generateFallbackInsights() {
                this.aiInsights = this.getFallbackInsights();
                this.updateAIInsightsDisplay();
            }

            getFallbackInsights() {
                const sessions = this.data.sessions;
                const metrics = this.data.metrics;
                
                return [
                    {
                        priority: 'high',
                        icon: 'üéØ',
                        content: `Current productivity score: ${metrics.productivityScore}/100. ${metrics.productivityScore < 50 ? 'Focus on consistency to improve your score.' : 'Great work maintaining good productivity!'}`
                    },
                    {
                        priority: 'medium',
                        icon: 'üìä',
                        content: `You've completed ${sessions.length} focus sessions with an average of ${this.getAverageSessionLength()}. ${sessions.length < 5 ? 'Try to establish a regular focus routine.' : 'Good session frequency!'}`
                    },
                    {
                        priority: 'low',
                        icon: '‚ö°',
                        content: `Current streak: ${this.getCurrentStreak()} days. ${this.getCurrentStreak() === 0 ? 'Start a new focus session to begin building a streak.' : 'Keep up the momentum!'}`
                    }
                ];
            }

            updateAIStatus(status) {
                const statusElement = document.getElementById('aiStatus');
                if (!statusElement) return;
                
                statusElement.className = status === 'processing' ? 'w-3 h-3 bg-yellow-500 rounded-full loading-spinner' : 'w-3 h-3 bg-green-500 rounded-full pulse-animation';
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    max-width: 400px;
                    font-size: 14px;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 4000);
            }
        }

        // Global variables
        let dashboard;

        // Tab management
        function showTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Update current tab
            if (dashboard) {
                dashboard.currentTab = tabName;
            }
        }

        // AI functions
        async function generateAIInsights() {
            if (dashboard) {
                await dashboard.generateAIInsights();
                dashboard.showNotification('üß† AI insights refreshed!', 'success');
            }
        }

        async function runFullAIAnalysis() {
            if (dashboard) {
                dashboard.showNotification('üîç Running deep AI analysis...', 'info');
                await dashboard.generateAIInsights();
            }
        }

        // Trends functions
        function updateTrends(period) {
            // Update trends based on selected period
            if (dashboard && dashboard.charts.trends) {
                dashboard.showNotification(`üìà Updated trends for ${period}`, 'success');
            }
        }

        // Report functions
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const dateRange = document.getElementById('reportDateRange').value;
            const includeAI = document.getElementById('includeAI').value;
            
            const preview = document.getElementById('reportPreview');
            preview.innerHTML = `
                <div class="report-preview">
                    <h3 class="text-lg font-semibold mb-4">üìã ${reportType.toUpperCase()} Report Preview</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 rounded">
                            <h4 class="font-medium mb-2">Report Period: ${dateRange}</h4>
                            <p class="text-sm text-gray-600">Data analysis for the selected time period</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded">
                            <h4 class="font-medium mb-2">Key Metrics</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>Total Focus Time: ${dashboard ? dashboard.formatTime(dashboard.data.metrics.totalFocusTime) : '0h'}</div>
                                <div>Sessions Completed: ${dashboard ? dashboard.data.metrics.completedSessions : '0'}</div>
                                <div>Productivity Score: ${dashboard ? dashboard.data.metrics.productivityScore : '0'}/100</div>
                                <div>Goal Progress: ${dashboard ? dashboard.data.metrics.goalProgress : '0'}%</div>
                            </div>
                        </div>
                        ${includeAI === 'yes' ? `
                        <div class="p-4 bg-red-50 rounded">
                            <h4 class="font-medium mb-2">ü§ñ AI Insights</h4>
                            <p class="text-sm text-gray-600">AI-generated recommendations and analysis included</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            if (dashboard) {
                dashboard.showNotification('üìã Report generated successfully!', 'success');
            }
        }

        function exportReport(format) {
            if (dashboard) {
                dashboard.showNotification(`üìÑ Exporting report as ${format.toUpperCase()}...`, 'info');
                // In a real implementation, this would generate and download the file
                setTimeout(() => {
                    dashboard.showNotification(`‚úÖ Report exported as ${format.toUpperCase()}!`, 'success');
                }, 2000);
            }
        }

        // Forecasting functions
        function generateForecast() {
            if (dashboard && dashboard.charts.forecast) {
                dashboard.showNotification('üîÆ Generating AI forecast...', 'info');
                dashboard.charts.forecast.update();
                setTimeout(() => {
                    if (dashboard) {
                        dashboard.showNotification('‚ú® Forecast updated with latest data!', 'success');
                    }
                }, 1500);
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            dashboard = new AnalyticsDashboard();
            
            // Add CSS animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>